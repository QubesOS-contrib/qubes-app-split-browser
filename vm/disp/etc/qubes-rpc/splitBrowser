#!/bin/bash
set -e -u -o pipefail
shopt -s inherit_errexit nullglob

for f in {,/usr/local}/etc/split-browser/disp/*.bash; do source "$f"; done
export SB_INTO_FIREFOX=/run/split-browser/into-firefox \
       SB_FROM_FIREFOX=/run/split-browser/from-firefox


socat "UNIX-LISTEN:$SB_FROM_FIREFOX,fork,max-children=1" STDIO &
trap "kill $!" EXIT
trap 'exit 0'  USR1
trap 'exit 1'  USR2

while IFS=$'\t' read -r -a cmd; do
    case "${cmd[0]}" in
        setup)
            cd -- "$SB_FIREFOX_DIR"

            js1=( /[u]sr{/local,}/share/split-browser/firefox/sb-load.js )
            mkdir -p          defaults/pref/
            ln -s "${js1[0]}" defaults/pref/

            js2=( /[u]sr{/local,}/share/split-browser/firefox/sb.js )
            printf '%s\n' '' "${cmd[@]:1}" | cat - "${js2[0]}" >sb.js
        ;;
        master)
            (
                "${SB_FIREFOX[@]}" "${cmd[@]:1}" && sig=USR1 || sig=USR2
                kill -s "$sig" $$
            ) &
        ;;
        helper)
            "${cmd[@]:1}"
        ;;
        newtab)
            socat STDIO "UNIX-CONNECT:$SB_INTO_FIREFOX" <<<"${cmd[1]}"
        ;;
    esac
done >&2
