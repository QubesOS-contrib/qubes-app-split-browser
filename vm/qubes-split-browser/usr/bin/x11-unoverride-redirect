#!/usr/bin/python3
#
# Run given command; switch override_redirect off on one new X11 window.
# Useful for working around https://github.com/QubesOS/qubes-issues/issues/2311
#
# Example: x11-unoverride-redirect dmenu -i

import subprocess
import sys
import xcffib
from xcffib import xproto
from xcffib.xproto import CW


def adjust_window(window, core):
    yield core.ChangeWindowAttributesChecked(window, CW.OverrideRedirect, [0])
    yield core.UnmapWindowChecked(window)
    yield core.MapWindowChecked(window)

def main():
    connection = xcffib.connect()
    core = connection.core

    core.ChangeWindowAttributesChecked(
        connection.setup.roots[0].root, CW.EventMask,
        [xproto.EventMask.SubstructureNotify]
    ).check()

    command = subprocess.Popen(sys.argv[1:], bufsize=0)

    for ev in iter(connection.wait_for_event, None):
        if command.poll() is not None:  # command finished
            break
        if isinstance(ev, xproto.CreateNotifyEvent) and ev.override_redirect:
            for cookie in list(adjust_window(ev.window, core)):
                cookie.check()
            break

    connection.disconnect()
    command.wait()
    status = command.returncode
    if status < 0:
        status = 128 - status
    return status


if __name__ == '__main__':
    sys.exit(main())
